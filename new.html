<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Result Analysis Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://unpkg.com/docx@8.2.2/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        @media print {
            body > * { display: none !important; }
            #printWrapper { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: white; }
            #activeReport { display: block !important; padding: 10mm !important; width: 100% !important; border: none !important; box-shadow: none !important; }
            canvas { max-width: 100% !important; height: auto !important; }
            table { width: 100%; border-collapse: collapse; page-break-inside: auto; }
            tr { page-break-inside: avoid; page-break-after: auto; }
            th, td { border: 1px solid black !important; }
            .page-break { page-break-before: always; }
            @page { size: A4; margin: 0; }
        }

        #printWrapper { display: none; }
        .report-shadow { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04); }
        .chart-container { position: relative; width: 100%; min-height: 350px; display: flex; justify-content: center; align-items: center; }
        
        .mode-btn-active { background-color: #4f46e5; color: white; border-color: #4f46e5; }
        .mode-btn-inactive { background-color: white; color: #64748b; border-color: #e2e8f0; }
    </style>
</head>
<body class="text-slate-900 p-0 md:p-8">
    <div id="printWrapper"></div>
    <div class="max-w-7xl mx-auto main-ui no-print">
        <header class="text-center mb-10">
            <h1 class="text-4xl font-bold text-indigo-900 mb-2 flex items-center justify-center gap-3">
                <i data-lucide="layout-dashboard" class="text-indigo-600"></i> Academic Result Analyzer
            </h1>
            <p class="text-slate-500 text-lg">Generate cumulative or individual analysis reports with visual charts.</p>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 mb-12">
            <div class="lg:col-span-4 space-y-6">
                <!-- Analysis Mode Selection -->
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="layers" class="w-5 h-5 text-indigo-600"></i> Analysis Mode
                    </h2>
                    <div class="flex gap-2">
                        <button id="modeProgram" class="flex-1 py-2 px-4 rounded-xl border font-medium transition-all mode-btn-active">Programwise</button>
                        <button id="modeSemester" class="flex-1 py-2 px-4 rounded-xl border font-medium transition-all mode-btn-inactive">Semesterwise</button>
                    </div>
                </div>

                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="upload" class="w-5 h-5 text-indigo-600"></i> 1. Upload Data
                    </h2>
                    <div id="dropZone" class="border-2 border-dashed border-slate-200 rounded-xl p-8 text-center cursor-pointer hover:border-indigo-400 hover:bg-indigo-50 transition-all group relative">
                        <i data-lucide="file-spreadsheet" class="w-12 h-12 mx-auto mb-3 text-slate-300 group-hover:text-indigo-500"></i>
                        <p id="dropZoneText" class="text-sm font-medium text-slate-700">Drag & Drop Tabulation Sheet</p>
                        <input type="file" id="fileInput" class="absolute inset-0 opacity-0 cursor-pointer" accept=".xlsx, .xls, .csv" multiple>
                    </div>
                    <div id="statusMessage" class="mt-4 hidden text-sm font-medium p-3 rounded-lg"></div>
                </div>

                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h2 class="text-lg font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="settings" class="w-5 h-5 text-indigo-600"></i> 2. Metadata
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Institution</label>
                            <input type="text" id="schoolInp" value="Dr. APJ ABDUL KALAM SCHOOL OF ENGINEERING" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Semester Name</label>
                            <input type="text" id="semInp" value="3rd SEMESTER B.Tech. Jan-2025" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Program</label>
                                <input type="text" id="progInp" placeholder="Detecting..." class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Batch</label>
                                <input type="text" id="secInp" placeholder="Detecting..." class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Date</label>
                            <input type="text" id="dateInp" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                        </div>
                    </div>
                </div>

                <div id="actionButtons" class="hidden space-y-3">
                    <button id="downloadWordBtn" class="w-full py-3 bg-blue-600 text-white rounded-xl font-bold shadow-lg shadow-blue-100 hover:bg-blue-700 hover:-translate-y-1 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="file-text" class="w-5 h-5"></i> Download Word (.docx)
                    </button>
                    <button id="downloadPdfBtn" class="w-full py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-lg shadow-emerald-100 hover:bg-emerald-700 hover:-translate-y-1 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="file-down" class="w-5 h-5"></i> Download PDF
                    </button>
                    <button id="printBtn" class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold shadow-lg shadow-slate-100 hover:bg-slate-900 hover:-translate-y-1 transition-all flex items-center justify-center gap-2">
                        <i data-lucide="printer" class="w-5 h-5"></i> Print Preview
                    </button>
                </div>
            </div>

            <div class="lg:col-span-8">
                <div id="reportContainer" class="bg-white rounded-2xl border border-slate-200 report-shadow min-h-[800px] overflow-hidden">
                    <div id="emptyState" class="h-full flex flex-col items-center justify-center text-slate-400 p-20 text-center">
                        <div class="bg-slate-50 p-6 rounded-full mb-4">
                            <i data-lucide="file-search" class="w-16 h-16 opacity-20"></i>
                        </div>
                        <p class="text-xl font-medium text-slate-600">No Data Loaded</p>
                        <p class="text-sm mt-2 max-w-xs">Upload tabulation files to generate analysis. Switch modes above for single or cumulative reports.</p>
                    </div>

                    <div id="activeReport" class="hidden p-[10mm] text-black bg-white">
                        <!-- Content injected by JS -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        Chart.register(ChartDataLabels);

        let analysisMode = 'program';
        let processedData = null;
        let activeChart = null;

        const fileInput = document.getElementById('fileInput');
        const modeProgram = document.getElementById('modeProgram');
        const modeSemester = document.getElementById('modeSemester');
        const dropZoneText = document.getElementById('dropZoneText');
        const actionButtons = document.getElementById('actionButtons');
        const statusMessage = document.getElementById('statusMessage');
        const activeReport = document.getElementById('activeReport');
        const emptyState = document.getElementById('emptyState');
        const printWrapper = document.getElementById('printWrapper');

        document.getElementById('dateInp').value = new Date().toLocaleDateString('en-GB');

        modeProgram.onclick = () => setMode('program');
        modeSemester.onclick = () => setMode('semester');

        function setMode(mode) {
            analysisMode = mode;
            modeProgram.className = `flex-1 py-2 px-4 rounded-xl border font-medium transition-all ${mode === 'program' ? 'mode-btn-active' : 'mode-btn-inactive'}`;
            modeSemester.className = `flex-1 py-2 px-4 rounded-xl border font-medium transition-all ${mode === 'semester' ? 'mode-btn-active' : 'mode-btn-inactive'}`;
            dropZoneText.innerText = mode === 'program' ? "Drag & Drop Tabulation Sheet" : "Drag & Drop Multiple Sheets (Ctrl+Select)";
            resetApp();
        }

        function resetApp() {
            processedData = null;
            emptyState.classList.remove('hidden');
            activeReport.classList.add('hidden');
            actionButtons.classList.add('hidden');
            statusMessage.classList.add('hidden');
            fileInput.value = '';
        }

        fileInput.onchange = async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;

            statusMessage.classList.remove('hidden', 'bg-emerald-50', 'text-emerald-700', 'bg-red-50', 'text-red-700');
            statusMessage.classList.add('bg-indigo-50', 'text-indigo-700');
            statusMessage.textContent = `Processing ${files.length} file(s)...`;

            try {
                const results = [];
                for (let file of files) {
                    const data = await file.arrayBuffer();
                    const workbook = XLSX.read(new Uint8Array(data), { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const rows = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    results.push({ rows });
                }
                
                processedData = (analysisMode === 'program') ? processSingle(results[0].rows) : processCumulative(results);
                renderReport();
            } catch (err) {
                statusMessage.textContent = 'Error: ' + err.message;
                statusMessage.classList.replace('bg-indigo-50', 'bg-red-50');
            }
        };

        function scanSheet(rows) {
            let codeRowIdx = -1, prog = "", batch = "";
            const courseRegex = /[0-9]+[A-Z]+[0-9]+/;
            const usnPattern = /^[0-9]{2}[A-Z]{3,5}[0-9]+$/;

            for (let i = 0; i < Math.min(rows.length, 20); i++) {
                const row = rows[i] || [];
                const rowText = row.join(' ');
                if (rowText.includes('Academic Batch')) batch = row.filter(c => c && c.toString().length > 1).join(' ').trim();
                if (rowText.includes('Program') || rowText.includes('B Tech')) prog = row.filter(c => c && c.toString().length > 3).join(' ').trim();
                if (codeRowIdx === -1 && row.some(c => c && typeof c === 'string' && courseRegex.test(c))) codeRowIdx = i;
            }

            const subjects = [];
            const codesRow = rows[codeRowIdx] || [];
            const facultyRow = rows[codeRowIdx - 1] || [];
            const nameRow = rows[codeRowIdx + 1] || [];
            const seen = new Set();
            
            codesRow.forEach((cell, idx) => {
                if (cell && typeof cell === 'string' && courseRegex.test(cell.trim())) {
                    const code = cell.trim();
                    if (!seen.has(code)) {
                        subjects.push({ code, faculty: facultyRow[idx] || 'Class Teacher', name: nameRow[idx] || 'Subject', resCol: idx + 6 });
                        seen.add(code);
                    }
                }
            });

            const validStudents = rows.slice(codeRowIdx + 1).filter(row => 
                row.slice(0, 5).some(c => c && typeof c === 'string' && usnPattern.test(c.replace(/\s/g, '').toUpperCase()))
            );

            let statusIdx = (rows[codeRowIdx] || []).findIndex(c => c && c.toString().toUpperCase() === 'STATUS');
            if (statusIdx === -1 && validStudents.length) {
                const sample = validStudents[0];
                for(let i = sample.length-1; i >= 0; i--) {
                    if(['PASS', 'FAIL', 'P', 'F'].includes(sample[i]?.toString().toUpperCase())) { statusIdx = i; break; }
                }
            }

            const stats = subjects.map(s => {
                let app = 0, p = 0, f = 0;
                validStudents.forEach(row => {
                    const res = row[s.resCol]?.toString().toUpperCase();
                    if (['PASS', 'FAIL', 'P', 'F'].includes(res)) {
                        app++;
                        if (['PASS', 'P'].includes(res)) p++; else f++;
                    }
                });
                return { ...s, app, p, f, pct: app > 0 ? (p/app*100).toFixed(2) : "0.00" };
            });

            const ovPass = validStudents.filter(r => ['PASS', 'P', 'PASSED'].includes(r[statusIdx]?.toString().toUpperCase())).length;
            return { meta: { prog, batch }, stats, overall: { app: validStudents.length, p: ovPass, f: validStudents.length - ovPass, pct: validStudents.length > 0 ? (ovPass/validStudents.length*100).toFixed(2) : "0.00" } };
        }

        function processSingle(rows) {
            const data = scanSheet(rows);
            return { mode: 'program', school: document.getElementById('schoolInp').value, title: document.getElementById('semInp').value, date: document.getElementById('dateInp').value, program: data.meta.prog || document.getElementById('progInp').value, batch: data.meta.batch || document.getElementById('secInp').value, subjects: data.stats, overall: data.overall };
        }

        function processCumulative(results) {
            const programs = [];
            const courseGroups = {};
            results.forEach(res => {
                const s = scanSheet(res.rows);
                programs.push({ name: s.meta.prog || "Program", ...s.overall });
                s.stats.forEach(item => {
                    const key = item.name.toUpperCase().trim();
                    if (!courseGroups[key]) courseGroups[key] = { name: item.name, faculty: item.faculty, app: 0, p: 0, f: 0 };
                    courseGroups[key].app += item.app; courseGroups[key].p += item.p; courseGroups[key].f += item.f;
                });
            });
            const totalApp = programs.reduce((a, b) => a + b.app, 0);
            const totalPass = programs.reduce((a, b) => a + b.p, 0);
            return { mode: 'semester', school: document.getElementById('schoolInp').value, title: document.getElementById('semInp').value, date: document.getElementById('dateInp').value, programs, subjects: Object.values(courseGroups).map(c => ({...c, pct: c.app > 0 ? (c.p/c.app*100).toFixed(2) : "0.00"})), overall: { app: totalApp, p: totalPass, f: totalApp - totalPass, pct: totalApp > 0 ? (totalPass/totalApp*100).toFixed(2) : "0.00" } };
        }

        function renderReport() {
            if (!processedData) return;
            emptyState.classList.add('hidden');
            activeReport.classList.remove('hidden');
            actionButtons.classList.remove('hidden');
            statusMessage.textContent = 'Report Generated Successfully';
            statusMessage.classList.replace('bg-indigo-50', 'bg-emerald-50');

            const header = `
                <div class="text-center mb-8 border-b-2 border-black pb-4 mt-0">
                    <h2 class="text-xl font-bold uppercase mb-1 mt-0">${processedData.school}</h2>
                    <div class="flex justify-between items-end text-[12px] font-bold mt-4">
                        <div class="text-left"><p>RESULT ANALYSIS FOR THE ${processedData.title}</p><p class="underline">${processedData.mode.toUpperCase()} RESULTS</p></div>
                        <p>Date: ${processedData.date}</p>
                    </div>
                </div>`;

            if (processedData.mode === 'program') {
                activeReport.innerHTML = header + renderProgramReport(processedData);
                renderBarChart('mainChart', processedData.subjects.map(s => s.code), processedData.subjects.map(s => s.pct));
            } else {
                activeReport.innerHTML = header + renderSemesterReport(processedData);
                renderPieChart('mainChart', processedData.programs.map(p => p.name), processedData.programs.map(p => p.app));
            }
        }

        function renderProgramReport(d) {
            return `
                <div class="flex justify-between mb-4 text-[12px] font-bold">
                    <p>Program: ${d.program}</p><p>Batch: ${d.batch}</p>
                </div>
                <table class="w-full border-collapse border border-black text-[10px] mb-6">
                    <tr class="bg-gray-100"><th>Code</th><th>Subject</th><th>Faculty</th><th>Appeared</th><th>Pass</th><th>Fail</th><th>% Pass</th></tr>
                    ${d.subjects.map(s => `<tr><td class="border border-black p-1">${s.code}</td><td class="border border-black p-1">${s.name}</td><td class="border border-black p-1">${s.faculty}</td><td class="border border-black p-1 text-center">${s.app}</td><td class="border border-black p-1 text-center">${s.p}</td><td class="border border-black p-1 text-center">${s.f}</td><td class="border border-black p-1 text-center font-bold">${s.pct}%</td></tr>`).join('')}
                </table>
                <div class="chart-container mb-6"><canvas id="mainChart"></canvas></div>
                <h4 class="text-[12px] font-bold mb-2 underline">OVERALL SUMMARY:</h4>
                <table class="w-[50%] border border-black text-[12px] text-center font-bold">
                    <tr class="bg-gray-100"><td>Appeared</td><td>Pass</td><td>Fail</td><td>% Pass</td></tr>
                    <tr><td>${d.overall.app}</td><td>${d.overall.p}</td><td>${d.overall.f}</td><td>${d.overall.pct}%</td></tr>
                </table>
                ${renderSigs()}`;
        }

        function renderSemesterReport(d) {
            return `
                <h4 class="text-[12px] font-bold mb-2 underline">PROGRAM WISE RESULTS (CUMULATIVE):</h4>
                <table class="w-full border-collapse border border-black text-[11px] mb-6">
                    <tr class="bg-gray-100"><th>Program Name</th><th>Appeared</th><th>Pass</th><th>Fail</th><th>% Pass</th></tr>
                    ${d.programs.map(p => `<tr><td class="border border-black p-2">${p.name}</td><td class="border border-black p-2 text-center">${p.app}</td><td class="border border-black p-2 text-center">${p.p}</td><td class="border border-black p-2 text-center">${p.f}</td><td class="border border-black p-2 text-center font-bold">${p.pct}%</td></tr>`).join('')}
                    <tr class="bg-slate-50 font-bold"><td class="border border-black p-2">OVERALL</td><td class="border border-black p-2 text-center">${d.overall.app}</td><td class="border border-black p-2 text-center">${d.overall.p}</td><td class="border border-black p-2 text-center">${d.overall.f}</td><td class="border border-black p-2 text-center">${d.overall.pct}%</td></tr>
                </table>
                <div class="chart-container mb-12"><div class="w-[350px] h-[350px]"><canvas id="mainChart"></canvas></div></div>
                <div class="page-break"></div>
                <h4 class="text-[12px] font-bold mt-8 mb-2 underline">COURSE WISE RESULTS (OVERALL):</h4>
                <table class="w-full border-collapse border border-black text-[10px]">
                    <tr class="bg-gray-100"><th>Subject Name</th><th>Appeared</th><th>Pass</th><th>Fail</th><th>% Pass</th></tr>
                    ${d.subjects.map(s => `<tr><td class="border border-black p-1">${s.name}</td><td class="border border-black p-1 text-center">${s.app}</td><td class="border border-black p-1 text-center">${s.p}</td><td class="border border-black p-1 text-center">${s.f}</td><td class="border border-black p-1 text-center font-bold">${s.pct}%</td></tr>`).join('')}
                </table>
                ${renderSigs()}`;
        }

        function renderSigs() {
            return `
                <div class="mt-20 grid grid-cols-3 gap-12 text-center text-[12px] font-bold">
                    <div><div class="h-10 border-b border-black mb-2"></div><p>Faculty Sign</p></div>
                    <div><div class="h-10 border-b border-black mb-2"></div><p>Class Teacher</p></div>
                    <div><div class="h-10 border-b border-black mb-2"></div><p>HOD / Principal</p></div>
                </div>`;
        }

        function renderBarChart(id, labels, data) {
            const ctx = document.getElementById(id).getContext('2d');
            activeChart = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets: [{ data: data.map(v => parseFloat(v)), backgroundColor: 'rgba(79, 70, 229, 0.75)', borderColor: 'rgb(79, 70, 229)', borderWidth: 1, barThickness: 25 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'right', formatter: v => v + '%', font: { weight: 'bold' }, color: '#4338ca' } }, scales: { x: { beginAtZero: true, max: 100 } } }
            });
        }

        function renderPieChart(id, labels, data) {
            const ctx = document.getElementById(id).getContext('2d');
            const colors = ['#4f46e5', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#06b6d4', '#ec4899'];
            activeChart = new Chart(ctx, {
                type: 'pie',
                data: { labels, datasets: [{ data, backgroundColor: colors.slice(0, labels.length) }] },
                options: { responsive: true, maintainAspectRatio: false, animation: false, plugins: { legend: { position: 'bottom' }, datalabels: { color: '#fff', font: { weight: 'bold' }, formatter: (v, ctx) => { let sum = ctx.dataset.data.reduce((a, b) => a + b, 0); return (v/sum*100).toFixed(1) + "%"; } } } }
            });
        }

        document.getElementById('downloadPdfBtn').onclick = () => {
            const opt = { 
                margin: [10, 10, 10, 10], 
                filename: 'Analysis_Report.pdf', 
                image: { type: 'jpeg', quality: 1 }, 
                html2canvas: { scale: 3, useCORS: true, scrollY: 0, y: 0 }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            };
            html2pdf().set(opt).from(activeReport).save();
        };

        document.getElementById('printBtn').onclick = () => {
            printWrapper.innerHTML = '';
            const clone = activeReport.cloneNode(true);
            clone.classList.remove('hidden');
            printWrapper.appendChild(clone);
            const canvases = clone.querySelectorAll('canvas');
            canvases.forEach((c, idx) => {
                const source = activeReport.querySelectorAll('canvas')[idx];
                const ctx = c.getContext('2d');
                ctx.drawImage(source, 0, 0);
            });
            setTimeout(() => window.print(), 500);
        };

        document.getElementById('downloadWordBtn').onclick = async () => {
            const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, ImageRun, AlignmentType } = docx;
            const chartImg = activeChart.toBase64Image();
            const doc = new Document({
                sections: [{
                    children: [
                        new Paragraph({ alignment: AlignmentType.CENTER, children: [new TextRun({ text: processedData.school, bold: true, size: 28 })] }),
                        new Paragraph({ children: [new TextRun({ text: `RESULT ANALYSIS: ${processedData.title}`, bold: true, size: 22 })] }),
                        new Table({ width: { size: 100, type: WidthType.PERCENTAGE }, rows: [
                            new TableRow({ children: ["Subject/Program", "Appeared", "Pass", "%"].map(h => new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: h, bold: true })] })] })) }),
                            ...(processedData.subjects || processedData.programs).map(s => new TableRow({ children: [s.name || s.code, s.app.toString(), s.p.toString(), `${s.pct}%`].map(v => new TableCell({ children: [new Paragraph({ text: v })] })) }))
                        ]}),
                        new Paragraph({ alignment: AlignmentType.CENTER, children: [new ImageRun({ data: Uint8Array.from(atob(chartImg.split(',')[1]), c => c.charCodeAt(0)), transformation: { width: 450, height: 300 } })] })
                    ]
                }]
            });
            Packer.toBlob(doc).then(blob => saveAs(blob, `Analysis_Report.docx`));
        };

        const dropZone = document.getElementById('dropZone');
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(e => dropZone.addEventListener(e, (ev) => { ev.preventDefault(); ev.stopPropagation(); if (e === 'dragover') dropZone.classList.add('border-indigo-400', 'bg-indigo-50'); else dropZone.classList.remove('border-indigo-400', 'bg-indigo-50'); }, false));
        dropZone.addEventListener('drop', (e) => { const files = e.dataTransfer.files; if (files.length) { fileInput.files = files; fileInput.dispatchEvent(new Event('change')); } });
    </script>
</body>
</html><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Academic Analytics - GCU</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/docx@8.2.2/build/index.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Times New Roman Global Standard */
        * { font-family: "Times New Roman", Times, serif !important; box-sizing: border-box; }
        body { background-color: #f1f5f9; margin: 0; padding: 0; }
        
        .report-section { page-break-inside: avoid !important; margin-bottom: 2rem; width: 100%; }
        .chart-container { position: relative; width: 100%; margin-top: 1rem; display: flex; justify-content: center; align-items: center; background: #fff; padding: 10px; border: 1px solid #e2e8f0; }

        /* Designed Tables */
        .academic-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; border: 2px solid #1e3a8a; table-layout: fixed; }
        .academic-table th { background-color: #1e3a8a !important; color: white !important; text-transform: uppercase; font-size: 13px; padding: 10px 5px; border: 1px solid #000; }
        .academic-table td { border: 1px solid #000; padding: 8px; font-size: 14px; color: black; vertical-align: middle; word-wrap: break-word; }
        
        /* Stripes */
        .academic-table tbody tr:nth-child(even) { background-color: #f1f7ff !important; }
        .academic-table tbody tr:nth-child(odd) { background-color: #ffffff !important; }
        
        .faculty-input-cell { font-weight: bold; outline: none; background-color: #fffdf0; }
        .overall-summary-row { background-color: #fee2e2 !important; color: #b91c1c !important; font-weight: bold; border-top: 2px solid #b91c1c !important; }

        @media print {
            body > * { display: none !important; }
            #printWrapper { display: block !important; position: absolute; top: 0; left: 0; width: 100%; background: white; }
            #activeReport { display: block !important; padding: 0 !important; width: 100% !important; border: none !important; margin: 0 !important; }
            @page { size: A4; margin: 0; }
        }

        /* Fixing Whitespace Issue: Content strictly anchors at 0,0 */
        #activeReport { background: white; width: 100%; width: 210mm; min-height: 297mm; margin: 0 auto; box-sizing: border-box; border: none; overflow: visible; height: auto; }
        .report-content-body { padding: 0 15mm 15mm 15mm; margin-top: 0; } 
        
        .university-header-text { 
            margin: 0; 
            padding: 8mm 0 4mm 0;
            font-size: 40px; 
            font-weight: bold; 
            color: #1e3a8a; 
            text-align: center; 
            border-bottom: 3px double #1e3a8a; 
            text-transform: uppercase; 
            line-height: 1;
        }

        .result-analysis-title {
            font-size: 54px;
            font-weight: bold;
            text-decoration: underline;
            text-align: center;
            margin: 15px 0;
            letter-spacing: 2px;
            color: #000;
            text-transform: uppercase;
        }

        .mode-btn-active { background-color: #1e3a8a !important; color: white !important; border-color: #1e3a8a !important; cursor: pointer !important; }
        .mode-btn-inactive { background-color: white !important; color: #64748b !important; border-color: #e2e8f0 !important; cursor: pointer !important; }

        .app-header { background-color: #1e3a8a; color: white; padding: 1.5rem; border-radius: 0 0 1.5rem 1.5rem; margin-bottom: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Force Center Alignment for Rowspan Cells */
        .rowspan-cell { 
            font-weight: bold !important; 
            font-size: 16px !important;
            text-align: center !important; 
            vertical-align: middle !important; 
            background-color: #ffffff !important; 
            color: #000 !important; 
            border: 1px solid #000 !important;
        }
    </style>
</head>
<body class="text-slate-900 md:p-4">
    <div id="printWrapper"></div>
    
    <div class="max-w-7xl mx-auto main-ui no-print">
        <header class="app-header flex flex-col items-center justify-center text-center">
            <div class="flex items-center justify-center gap-6 mb-2">
                <img src="https://www.gardencity.university/wp-content/uploads/2023/03/GCU-Logo-White.png" alt="GCU" class="h-[60px] w-auto">
                <h1 class="text-4xl font-bold tracking-tight uppercase">Academic Analytics</h1>
            </div>
        </header>

        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <div class="lg:col-span-4 space-y-6">
                <!-- Modes -->
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-indigo-900 uppercase">
                        <i data-lucide="layers" class="w-5 h-5"></i> Analysis Mode
                    </h2>
                    <div class="flex gap-2">
                        <button id="modeProgram" class="flex-1 py-3 px-4 rounded-xl border font-bold mode-btn-active uppercase text-xs">Programwise</button>
                        <button id="modeSemester" class="flex-1 py-3 px-4 rounded-xl border font-bold mode-btn-inactive uppercase text-xs">Semesterwise</button>
                    </div>
                </div>

                <!-- Step 1: Import -->
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-indigo-900 uppercase">
                        <i data-lucide="upload" class="w-5 h-5"></i> 1. Import Data
                    </h2>
                    <div id="dropZone" class="border-2 border-dashed border-indigo-200 rounded-xl p-8 text-center cursor-pointer hover:border-indigo-400 hover:bg-indigo-50 relative">
                        <i data-lucide="file-spreadsheet" class="w-12 h-12 mx-auto mb-3 text-indigo-300"></i>
                        <p id="dropZoneText" class="text-sm font-bold text-slate-700 uppercase">Drop Excel Files Here</p>
                        <input type="file" id="fileInput" class="absolute inset-0 opacity-0 cursor-pointer" accept=".xlsx, .xls, .csv" multiple>
                    </div>
                    <div id="statusMessage" class="mt-4 hidden text-sm font-bold p-3 rounded-lg text-center"></div>
                </div>

                <!-- Step 2: Info -->
                <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                    <h2 class="text-lg font-bold mb-4 flex items-center gap-2 text-indigo-900 uppercase">
                        <i data-lucide="settings" class="w-5 h-5"></i> 2. Header Customization
                    </h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Department</label>
                            <input list="deptOptions" id="deptSelect" class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold uppercase outline-none focus:ring-2 focus:ring-indigo-500" placeholder="Type Dept...">
                            <datalist id="deptOptions">
                                <option value="Engineering"><option value="Management"><option value="Commerce"><option value="Computer Science"><option value="Microbiology">
                            </datalist>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-400 uppercase mb-1 text-orange-600">Program Name Override</label>
                            <input type="text" id="progNameInp" placeholder="Enter Program Name..." class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold uppercase">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Academic Batch</label>
                                <input type="text" id="batchInp" placeholder="Batch..." class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold uppercase">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Semester</label>
                                <input type="text" id="semInp" placeholder="Semester..." class="w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm font-bold uppercase">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Step 3: Actions -->
                <div id="actionButtons" class="hidden space-y-4">
                    <button id="genFacultySubjectBtn" disabled class="w-full py-4 bg-orange-500 text-white rounded-xl font-bold hover:bg-orange-600 shadow-lg uppercase text-xs border-b-4 border-orange-700 transition-all">
                        <i data-lucide="user-check" class="w-5 h-5 inline mr-1"></i> Faculty Subjectwise Report
                    </button>
                    <div class="grid grid-cols-2 gap-3">
                        <button id="downloadWordBtn" class="py-4 bg-blue-600 text-white rounded-xl font-bold hover:bg-blue-700 shadow-lg uppercase text-xs">Word</button>
                        <button id="downloadPdfBtn" class="py-4 bg-emerald-600 text-white rounded-xl font-bold hover:bg-emerald-700 shadow-lg uppercase text-xs">PDF</button>
                    </div>
                </div>
            </div>

            <!-- Preview Container -->
            <div class="lg:col-span-8">
                <div id="reportContainer" class="bg-white rounded-2xl border border-slate-200 shadow-xl min-h-[800px] overflow-hidden">
                    <div id="emptyState" class="h-[800px] flex flex-col items-center justify-center text-slate-400 p-20 text-center uppercase font-bold">
                        <i data-lucide="file-search" class="w-16 h-16 text-indigo-900 mb-6"></i>
                        <p>Import Excel Files to Start Analysis</p>
                    </div>
                    <div id="activeReport" class="hidden"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        Chart.register(ChartDataLabels);

        let currentMode = 'program';
        let processedData = null;
        let chartInstances = [];
        const COLOR_PALETTE = ['#1e3a8a', '#059669', '#b45309', '#b91c1c', '#6d28d9', '#0e7490', '#be123c', '#15803d', '#a21caf', '#7c2d12'];

        const modeProgram = document.getElementById('modeProgram');
        const modeSemester = document.getElementById('modeSemester');
        const fileInput = document.getElementById('fileInput');
        const deptSelect = document.getElementById('deptSelect');
        const progNameInp = document.getElementById('progNameInp');
        const semInp = document.getElementById('semInp');
        const batchInp = document.getElementById('batchInp');
        const activeReport = document.getElementById('activeReport');
        const emptyState = document.getElementById('emptyState');
        const actionButtons = document.getElementById('actionButtons');
        const genFacultySubjectBtn = document.getElementById('genFacultySubjectBtn');

        modeProgram.onclick = () => { currentMode = 'program'; resetUI(); };
        modeSemester.onclick = () => { currentMode = 'semester'; resetUI(); };

        function resetUI() {
            modeProgram.className = `flex-1 py-3 px-4 rounded-xl border font-bold transition-all uppercase text-xs ${currentMode === 'program' ? 'mode-btn-active' : 'mode-btn-inactive'}`;
            modeSemester.className = `flex-1 py-3 px-4 rounded-xl border font-bold transition-all uppercase text-xs ${currentMode === 'semester' ? 'mode-btn-active' : 'mode-btn-inactive'}`;
            activeReport.classList.add('hidden');
            emptyState.classList.remove('hidden');
            actionButtons.classList.add('hidden');
            fileInput.value = '';
            processedData = null;
            chartInstances.forEach(c => c.destroy());
            chartInstances = [];
        }

        fileInput.onchange = async (e) => {
            const files = Array.from(e.target.files);
            if (!files.length) return;
            try {
                const sheetData = [];
                for (let file of files) {
                    const data = await file.arrayBuffer();
                    const wb = XLSX.read(new Uint8Array(data), { type: 'array' });
                    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                    sheetData.push({ rows, name: file.name });
                }
                processBatch(sheetData);
            } catch (err) { alert("Error reading files: " + err.message); }
        };

        function scanSheet(rows) {
            let codeRowIdx = -1;
            const courseRegex = /[0-9]+[A-Z]+[0-9]+/;
            const usnPattern = /^[0-9]{2}[A-Z]{3,5}[0-9]+$/;
            const row3 = (rows[2] || []).filter(c => c).join(' ').trim();
            const row4 = (rows[3] || []).filter(c => c).join(' ').trim();

            for (let i = 0; i < Math.min(rows.length, 30); i++) {
                if (codeRowIdx === -1 && (rows[i] || []).some(c => typeof c === 'string' && courseRegex.test(c))) codeRowIdx = i;
            }

            const nameRow = rows[codeRowIdx + 1] || [];
            const codesRow = rows[codeRowIdx] || [];
            const subjects = [];
            const seen = new Set();
            codesRow.forEach((cell, idx) => {
                if (cell && typeof cell === 'string' && courseRegex.test(cell.trim())) {
                    const code = cell.trim();
                    if (!seen.has(code)) {
                        subjects.push({ code, faculty: "", name: (nameRow[idx] || 'Subject').toString().trim(), resCol: idx + 6 });
                        seen.add(code);
                    }
                }
            });

            const studentRows = rows.slice(codeRowIdx + 1).filter(row => row.slice(0, 5).some(c => c && typeof c === 'string' && usnPattern.test(c.replace(/\s/g, '').toUpperCase())));
            let statusIdx = (rows[codeRowIdx] || []).findIndex(c => c && c.toString().toUpperCase() === 'STATUS');
            const stats = subjects.map(s => {
                let app = 0, p = 0;
                studentRows.forEach(row => {
                    const res = (row[s.resCol] || "").toString().toUpperCase().trim();
                    if (['PASS', 'FAIL', 'P', 'F'].includes(res)) { app++; if (['PASS', 'P'].includes(res)) p++; }
                });
                return { ...s, app, p, pct: app > 0 ? (p/app*100).toFixed(2) : "0.00" };
            });

            const ovPass = studentRows.filter(r => ['PASS', 'P', 'PASSED'].includes(r[statusIdx]?.toString().toUpperCase().trim())).length;
            return { prog: row3, batch: row4, subjects: stats, overall: { app: studentRows.length, p: ovPass, pct: studentRows.length > 0 ? (ovPass/studentRows.length*100).toFixed(2) : "0.00" } };
        }

        function processBatch(sheets) {
            const reports = sheets.map(s => scanSheet(s.rows));
            const totalApp = reports.reduce((a, b) => a + b.overall.app, 0);
            const totalPass = reports.reduce((a, b) => a + b.overall.p, 0);

            processedData = {
                cumulative: reports.map(r => ({ name: r.prog, ...r.overall })),
                reports: reports,
                overall: { app: totalApp, p: totalPass, pct: totalApp > 0 ? (totalPass/totalApp*100).toFixed(2) : "0.00" },
                courseAggregated: []
            };

            batchInp.value = reports[0].batch.toUpperCase();
            semInp.value = reports[0].batch.toUpperCase();
            progNameInp.value = (currentMode === 'program' ? reports[0].prog : "Cumulative View").toUpperCase();
            
            const globalSubjMap = {};
            reports.forEach(r => {
                r.subjects.forEach(s => {
                    const key = s.name.toUpperCase();
                    if (!globalSubjMap[key]) globalSubjMap[key] = { name: s.name, app: 0, p: 0 };
                    globalSubjMap[key].app += s.app;
                    globalSubjMap[key].p += s.p;
                });
            });
            processedData.courseAggregated = Object.values(globalSubjMap).map(cs => ({ ...cs, pct: cs.app > 0 ? (cs.p/cs.app*100).toFixed(2) : "0.00" }));
            renderReport();
        }

        function syncHeaders() {
            if (!processedData) return;
            const rawDept = (deptSelect.value || "DEPARTMENT").toUpperCase();
            const deptHeader = rawDept.includes("DEPARTMENT") ? rawDept : `${rawDept} DEPARTMENT`;
            document.querySelectorAll('#report-dept-header, #report-footer-dept').forEach(el => el.innerText = deptHeader);

            const bVal = (batchInp.value || "N/A").toUpperCase();
            const sVal = (semInp.value || "N/A").toUpperCase();
            const pVal = (progNameInp.value || "N/A").toUpperCase();

            document.querySelectorAll('[id^="report-batch-val-"]').forEach(el => el.innerText = bVal);
            document.querySelectorAll('[id^="report-sem-val-"]').forEach(el => el.innerText = sVal);
            document.querySelectorAll('[id^="report-prog-val-"]').forEach(el => el.innerText = pVal);
        }

        function scrapeFacultyNames() {
            let allFilled = true;
            document.querySelectorAll('.faculty-input-cell').forEach(cell => { if (!cell.innerText.trim()) allFilled = false; });
            genFacultySubjectBtn.disabled = !allFilled;

            const courseMap = {}; 
            processedData.reports.forEach((report, rIdx) => {
                const tableRows = document.querySelectorAll(`#subj-table-${rIdx} tbody tr`);
                tableRows.forEach((tr, sIdx) => {
                    const facultyNameRaw = tr.querySelector('.faculty-input-cell').innerText.trim();
                    const subject = report.subjects[sIdx];
                    subject.faculty = facultyNameRaw;
                    if (facultyNameRaw) {
                        const cKey = subject.name.toUpperCase();
                        if (!courseMap[cKey]) courseMap[cKey] = { name: subject.name, faculties: {} };
                        const names = facultyNameRaw.split(/[,&/]/).map(n => n.trim()).filter(n => n.length > 0);
                        names.forEach(name => {
                            const fKey = name.toUpperCase();
                            if (!courseMap[cKey].faculties[fKey]) courseMap[cKey].faculties[fKey] = { name, app: 0, p: 0 };
                            courseMap[cKey].faculties[fKey].app += subject.app;
                            courseMap[cKey].faculties[fKey].p += subject.p;
                        });
                    }
                });
            });

            processedData.comparisonList = Object.values(courseMap).map(c => ({
                courseName: c.name,
                faculties: Object.values(c.faculties).map(f => ({ ...f, pct: f.app > 0 ? (f.p/f.app*100).toFixed(2) : "0.00" }))
            }));
        }

        function renderReport() {
            if (!processedData) return;
            emptyState.classList.add('hidden'); activeReport.classList.remove('hidden'); actionButtons.classList.remove('hidden');

            const rawDept = (deptSelect.value || "DEPARTMENT").toUpperCase();
            const deptHeader = rawDept.includes("DEPARTMENT") ? rawDept : `${rawDept} DEPARTMENT`;

            let html = `
                <div class="university-header-text">GARDEN CITY UNIVERSITY</div>
                <div class="report-content-body">
                    <div class="text-center">
                        <h2 id="report-dept-header" class="text-2xl font-bold uppercase mb-1">${deptHeader}</h2>
                        <h3 class="result-analysis-title">RESULT ANALYSIS</h3>
                        <div class="flex justify-end w-full text-[14px] font-bold"><p>Date: ${new Date().toLocaleDateString('en-GB')}</p></div>
                    </div>`;

            if (currentMode === 'semester') {
                html += `
                    <div class="report-section">
                        <h4 class="text-[14px] font-bold mb-2 underline uppercase">Cumulative Semester Overview:</h4>
                        <table class="academic-table">
                            <thead><tr><th style="width:50%">Program</th><th style="width:12%">Appeared</th><th style="width:12%">Passed</th><th style="width:12%">Failed</th><th style="width:14%">% Pass</th></tr></thead>
                            <tbody>
                            ${processedData.cumulative.map((p, idx) => `<tr><td class="font-bold editable-program" contenteditable="true" onblur="processedData.cumulative[${idx}].name=this.innerText; syncHeaders();">${p.name}</td><td class="text-center">${p.app}</td><td class="text-center">${p.p}</td><td class="text-center">${p.app-p.p}</td><td class="text-center font-bold">${p.pct}%</td></tr>`).join('')}
                            <tr class="bg-slate-100 font-bold" style="color: #1e3a8a;"><td>TOTAL AGGREGATE</td><td class="text-center">${processedData.overall.app}</td><td class="text-center">${processedData.overall.p}</td><td class="text-center">${processedData.overall.app-processedData.overall.p}</td><td class="text-center">${processedData.overall.pct}%</td></tr>
                            </tbody>
                        </table>
                        <div class="chart-container h-[350px]"><canvas id="cumulativePie"></canvas></div>
                    </div>`;
            }

            processedData.reports.forEach((report, rIdx) => {
                html += `
                    <div class="report-section">
                        <div class="flex justify-between mb-2 text-[14px] font-bold text-indigo-900 uppercase">
                            <p>PROGRAM: <span id="report-prog-val-${rIdx}" contenteditable="true" class="px-1 border-b border-indigo-200">${progNameInp.value || report.prog}</span></p>
                            <p>BATCH: <span id="report-batch-val-${rIdx}" contenteditable="true" class="px-1 border-b border-indigo-200">${batchInp.value}</span></p>
                        </div>
                        <div class="mb-4 text-[14px] font-bold text-indigo-900 uppercase">
                            <p>Semester: <span id="report-sem-val-${rIdx}" contenteditable="true" class="px-1 border-b border-indigo-200">${semInp.value}</span></p>
                        </div>
                        <h5 class="text-[13px] font-bold mb-2 underline uppercase">Subject-wise Performance:</h5>
                        <table class="academic-table" id="subj-table-${rIdx}">
                            <thead><tr><th style="width:15%">Code</th><th style="width:35%">Course Name</th><th style="width:20%">Faculty Name</th><th style="width:10%">App.</th><th style="width:10%">Pass</th><th style="width:10%">% Pass</th></tr></thead>
                            <tbody>
                            ${report.subjects.map(s => `<tr><td class="font-bold">${s.code}</td><td>${s.name}</td><td class="faculty-input-cell uppercase" contenteditable="true" onblur="scrapeFacultyNames()">${s.faculty}</td><td class="text-center">${s.app}</td><td class="text-center">${s.p}</td><td class="text-center font-bold">${s.pct}%</td></tr>`).join('')}
                            </tbody>
                        </table>
                        <div class="chart-container" style="height:${Math.max(300, report.subjects.length * 40)}px"><canvas id="bar-subj-${rIdx}"></canvas></div>
                    </div>`;
            });

            html += `
                <div id="faculty-analytics-section" class="hidden">
                    <div class="page-break mt-12"></div>
                    <div class="report-section mt-12">
                        <h4 class="text-[16px] font-bold mb-8 underline uppercase tracking-widest text-center">Faculty - Subject Comparison Report</h4>
                        <table class="academic-table">
                            <thead><tr><th style="width:35%">Course Name</th><th style="width:30%">Faculty Name</th><th style="width:15%">Appeared</th><th style="width:15%">Passed</th><th style="width:15%">% Pass</th></tr></thead>
                            <tbody id="fac-table-body"></tbody>
                        </table>
                        <div id="fac-chart-container" class="chart-container hidden"><canvas id="bar-fac-subj-comparison"></canvas></div>
                    </div>
                </div>`;

            if (currentMode === 'semester') {
                html += `
                    <div class="page-break mt-12"></div>
                    <div class="report-section mt-12">
                        <h4 class="text-[16px] font-bold mb-4 underline uppercase tracking-widest text-center text-blue-900">Overall Course-wise Cumulative Analysis</h4>
                        <table class="academic-table">
                            <thead><tr><th style="width:60%">Subject Name</th><th style="width:13%">Total Appeared</th><th style="width:13%">Total Passed</th><th style="width:14%">Overall % Pass</th></tr></thead>
                            <tbody>
                                ${processedData.courseAggregated.map(cs => `<tr><td class="font-bold">${cs.name}</td><td class="text-center">${cs.app}</td><td class="text-center">${cs.p}</td><td class="text-center font-bold">${cs.pct}%</td></tr>`).join('')}
                            </tbody>
                        </table>
                        <div class="chart-container" style="height: 450px;"><canvas id="bar-course-overall"></canvas></div>
                    </div>`;
            }

            html += `
                <div class="mt-20 grid grid-cols-3 gap-10 text-center text-[14px] font-bold">
                    <div><div class="h-10 border-b border-black mb-1"></div><p>Verified Faculty</p></div>
                    <div><div class="h-10 border-b border-black mb-1"></div><p>Class Coordinator</p></div>
                    <div><div class="h-10 border-b border-black mb-1"></div><p id="report-footer-dept">${deptHeader}</p></div>
                </div></div>`;

            activeReport.innerHTML = html;
            setTimeout(initBaseCharts, 100);
        }

        function initBaseCharts() {
            chartInstances.forEach(c => c.destroy()); chartInstances = [];
            if (currentMode === 'semester') {
                const pie = document.getElementById('cumulativePie');
                if (pie) chartInstances.push(new Chart(pie.getContext('2d'), { type: 'pie', data: { labels: processedData.cumulative.map(p => p.name), datasets: [{ data: processedData.cumulative.map(p => p.app), backgroundColor: COLOR_PALETTE }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { datalabels: { color: '#fff', font: { weight: 'bold' } } } } }));
                const co = document.getElementById('bar-course-overall');
                if (co) chartInstances.push(new Chart(co.getContext('2d'), { type: 'bar', data: { labels: processedData.courseAggregated.map(cs => cs.name), datasets: [{ data: processedData.courseAggregated.map(cs => parseFloat(cs.pct)), backgroundColor: COLOR_PALETTE.slice(1) }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { max: 110 } }, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'right', formatter: v => v + '%' } }, barPercentage: 0.6 } }));
            }
            processedData.reports.forEach((report, idx) => {
                const ctx = document.getElementById(`bar-subj-${idx}`);
                if (ctx) chartInstances.push(new Chart(ctx.getContext('2d'), { type: 'bar', data: { labels: report.subjects.map(s => s.name), datasets: [{ data: report.subjects.map(s => parseFloat(s.pct)), backgroundColor: report.subjects.map((_, i) => COLOR_PALETTE[i % COLOR_PALETTE.length]) }] }, options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { max: 110 } }, plugins: { legend: { display: false }, datalabels: { anchor: 'end', align: 'right', formatter: v => v + '%' } }, barPercentage: 0.6 } }));
            });
        }

        deptSelect.oninput = syncHeaders; progNameInp.oninput = syncHeaders; batchInp.oninput = syncHeaders; semInp.oninput = syncHeaders;

genFacultySubjectBtn.onclick = function() {
    const section = document.getElementById('faculty-analytics-section');
    const tbody = document.getElementById('fac-table-body');
    const chartDiv = document.getElementById('fac-chart-container');
    const canvas = document.getElementById('bar-fac-subj-comparison');

    section.classList.remove('hidden');

    let facultyRows = "";
    let flatData = [];

    processedData.comparisonList.forEach(group => {
        let tApp = 0, tP = 0;

        const totalRows = currentMode === 'semester'
            ? group.faculties.length + 1
            : group.faculties.length;

        group.faculties.forEach((fac, fIdx) => {
            tApp += fac.app;
            tP += fac.p;

            facultyRows += `<tr>
                ${fIdx === 0 ? `<td class="rowspan-cell" rowspan="${totalRows}">${group.courseName}</td>` : ''}
                <td class="uppercase">${fac.name}</td>
                <td class="text-center">${fac.app}</td>
                <td class="text-center">${fac.p}</td>
                <td class="text-center font-bold">${fac.pct}%</td>
            </tr>`;

            flatData.push({
                faculty: fac.name,
                val: parseFloat(fac.pct),
                course: group.courseName
            });
        });

        if (currentMode === 'semester') {
            const ovPct = tApp > 0 ? ((tP / tApp) * 100).toFixed(2) : "0.00";
            facultyRows += `
            <tr class="overall-summary-row">
                <td class="uppercase">OVERALL</td>
                <td class="text-center">${tApp}</td>
                <td class="text-center">${tP}</td>
                <td class="text-center">${ovPct}%</td>
            </tr>`;
        }
    });

    tbody.innerHTML = facultyRows;

    if (currentMode === 'program') {
        chartDiv.classList.remove('hidden');

        const old = chartInstances.findIndex(c => c.canvas.id === 'bar-fac-subj-comparison');
        if (old !== -1) {
            chartInstances[old].destroy();
            chartInstances.splice(old, 1);
        }

        chartDiv.style.height = Math.max(400, flatData.length * 50 + 100) + 'px';

        chartInstances.push(new Chart(canvas.getContext('2d'), {
            type: 'bar',
            data: {
                labels: flatData.map(d => d.faculty),
                datasets: [{
                    data: flatData.map(d => d.val),
                    backgroundColor: flatData.map((_, i) => COLOR_PALETTE[(i + 3) % COLOR_PALETTE.length])
                }]
            },
            options: {
                indexAxis: 'y',
                responsive: true,
                maintainAspectRatio: false,
                scales: { x: { max: 110 } },
                plugins: {
                    legend: { display: false },
                    datalabels: {
                        anchor: 'end',
                        align: 'right',
                        formatter: (v, ctx) => `${flatData[ctx.dataIndex].course} (${v}%)`,
                        font: { size: 10, weight: 'bold' }
                    }
                }
            }
        }));
    } else {
        chartDiv.classList.add('hidden');
    }

    section.scrollIntoView({ behavior: 'smooth' });
};


        document.getElementById('downloadPdfBtn').onclick = () => {
            const element = document.getElementById('activeReport');
            window.scrollTo(0,0); // Essential for html2pdf positioning
            const opt = { 
                margin: 0, 
                filename: 'GCU_Analysis.pdf', 
                image: { type: 'jpeg', quality: 1 }, 
                html2canvas: { scale: 3, useCORS: true, scrollY: 0, scrollX: 0 }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            };
            html2pdf().set(opt).from(element).save();
        };

        document.getElementById('downloadWordBtn').onclick = async () => {
            const { Document, Packer, Paragraph, TextRun, Table, TableRow, TableCell, WidthType, ImageRun, AlignmentType, BorderStyle } = window.docx;
            const b = { style: BorderStyle.SINGLE, size: 1 }; const cs = { borders: { top: b, bottom: b, left: b, right: b } };
            const children = [
                new Paragraph({ alignment: AlignmentType.CENTER, children: [new TextRun({ text: "GARDEN CITY UNIVERSITY", bold: true, size: 48, color: "1e3a8a" })] }),
                new Paragraph({ alignment: AlignmentType.CENTER, children: [new TextRun({ text: (deptSelect.value || "ACADEMIC") + " DEPARTMENT", bold: true, size: 36 })] }),
                new Paragraph({ alignment: AlignmentType.CENTER, children: [new TextRun({ text: "RESULT ANALYSIS", bold: true, underline: {}, size: 40 })] }),
                new Paragraph({ alignment: AlignmentType.RIGHT, children: [new TextRun({ text: `Date: ${new Date().toLocaleDateString('en-GB')}`, size: 24 })] }),
                new Paragraph({ text: "" })
            ];
            processedData.reports.forEach((report, idx) => {
                children.push(new Paragraph({ children: [new TextRun({ text: `PROGRAM: ${progNameInp.value || report.prog} | BATCH: ${batchInp.value}`, bold: true, size: 24 })] }));
                const tableRows = [new TableRow({ children: ["Course", "Faculty", "Pass %"].map(h => new TableCell({ ...cs, children: [new Paragraph({ children: [new TextRun({ text: h, bold: true })] })] })) }), ...report.subjects.map(s => new TableRow({ children: [s.name, s.faculty, `${s.pct}%`].map(v => new TableCell({ ...cs, children: [new Paragraph({ text: v })] })) }))];
                children.push(new Table({ width: { size: 100, type: WidthType.PERCENTAGE }, rows: tableRows }));
                const c = chartInstances.find(c => c.canvas.id === `bar-subj-${idx}`);
                if (c) children.push(new Paragraph({ alignment: AlignmentType.CENTER, children: [new ImageRun({ data: Uint8Array.from(atob(c.canvas.toDataURL().split(',')[1]), c => c.charCodeAt(0)), transformation: { width: 550, height: 300 } })] }));
                children.push(new Paragraph({ text: "", pageBreakBefore: true }));
            });
            Packer.toBlob(new Document({ sections: [{ children }] })).then(blob => saveAs(blob, `Academic_Report.docx`));
        };
    </script>
</body>
</html>